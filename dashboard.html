<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Vinix7</title>
  <style>
    /* Minimal, clean styles mengikuti layout contoh gambar */
    :root{
      --blue:#163b8f;
      --muted:#f3f4f6;
      --card:#ffffff;
      --gray:#6b7280;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:#fafafa;color:#111;}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:#fff;border-bottom:1px solid #eee;}
    header .brand{font-weight:700;color:var(--blue);}
    nav a{margin-left:18px;text-decoration:none;color:#111;font-weight:600;}
    .container{max-width:1100px;margin:28px auto;padding:0 20px;}
    .top-card{display:flex;gap:20px;align-items:center;background:#fff;padding:22px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.04);}
    .avatar{width:96px;height:96px;border-radius:50%;overflow:hidden;border:4px solid #f1f5f9;flex:0 0 96px}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .profile-info h1{margin:0;font-size:22px;}
    .profile-info .role{color:var(--gray);margin-top:6px;}
    .edit-btn{margin-top:12px;padding:8px 14px;border-radius:8px;background:transparent;border:1px solid #ddd;cursor:pointer;}
    .progress{margin-top:14px;background:var(--muted);height:10px;border-radius:999px;overflow:hidden;width:320px}
    .progress .bar{height:100%;background:var(--blue);width:70%}
    .quick-actions{display:flex;gap:16px;margin-top:22px;}
    .action{flex:1;background:#fff;padding:18px;border-radius:10px;text-align:center;box-shadow:0 1px 2px rgba(0,0,0,0.03);}
    .main-grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:20px}
    .card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.04);}
    .skills {display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .tag{background:#fff3c4;padding:6px 10px;border-radius:999px;font-weight:600;font-size:13px}
    .nav-pages{display:flex;gap:8px;margin-top:18px}
    .nav-pages button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .nav-pages button.active{background:var(--blue);color:#fff;border-color:var(--blue)}
    /* small responsive */
    @media (max-width:900px){
      .main-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">VINIX7</div>
    <nav>
      <a href="#" id="nav-home">Home</a>
      <a href="#" id="nav-skill">Skill Passport</a>
      <a href="#" id="nav-showcase">Showcase</a>
      <button id="btn-logout" style="margin-left:18px;padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer">Logout</button>
    </nav>
  </header>

  <main class="container">
    <!-- Top profile -->
    <div class="top-card">
      <div class="avatar" id="avatar-container">
        <!-- image injected here -->
    <img src="" alt="avatar" id="avatar-img"
          onerror="this.src='assets/default-profile.png'">
      </div>
      <div class="profile-info">
        <h1 id="profile-name">Loading...</h1>
        <div class="role" id="profile-role">—</div>
        <button class="edit-btn" id="edit-profile">Edit Profil</button>
        <div class="progress" title="Kelengkapan Showcase">
          <div class="bar" id="progress-bar" style="width:0%"></div>
        </div>
        <div style="color:#6b7280;font-size:13px;margin-top:8px" id="profile-bio">—</div>
      </div>

      <div style="margin-left:auto;">
        <div style="text-align:right">
          <div style="font-weight:700" id="profile-percent">0% Selesai</div>
          <div style="color:var(--gray);font-size:13px">Tingkatkan profil untuk visibilitas</div>
        </div>
      </div>
    </div>

    <!-- Nav pages inside dashboard -->
    <div style="margin-top:16px" class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:700">Dashboard</div>
        <div class="nav-pages">
          <button id="page-home-btn" class="active">Home</button>
          <button id="page-skill-btn">Skill Passport</button>
          <button id="page-showcase-btn">Showcase</button>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <!-- left content / dynamic pages -->
      <div id="left-column">
        <div id="page-home" class="card">
          <h3>Halo, <span id="greet-name">—</span></h3>
          <p id="home-intro">Ini ringkasan profilmu.</p>

          <h4 style="margin-top:14px">Aktivitas Terbaru</h4>
          <ul id="activity-list" style="padding-left:18px;color:var(--gray);"></ul>
        </div>

        <div id="page-skill" class="card" style="display:none;">
          <h3>Skill Passport</h3>
          <p style="color:var(--gray)">Sebuah kurasi kompetensi dirimu.</p>
          <div style="display:flex;gap:12px;margin-top:14px;flex-wrap:wrap">
            <div style="flex:1;min-width:180px" class="card">
              <strong>Technical Skills</strong>
              <div class="skills" id="tech-skills"></div>
            </div>
            <div style="flex:1;min-width:180px" class="card">
              <strong>Design Skills</strong>
              <div class="skills" id="design-skills"></div>
            </div>
            <div style="flex:1;min-width:180px" class="card">
              <strong>Soft Skills</strong>
              <div class="skills" id="soft-skills"></div>
            </div>
          </div>
        </div>

        <div id="page-showcase" class="card" style="display:none;">
          <h3>Showcase / Portofolio</h3>
          <p style="color:var(--gray)">Kumpulan contoh pekerjaan.</p>
          <div id="portfolio-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px"></div>
        </div>
      </div>

      <!-- right column summary -->
      <aside>
        <div class="card">
          <strong>Ringkasan</strong>
          <div style="margin-top:12px">
            <div><strong>Nama</strong><div id="right-name" style="color:var(--gray)"></div></div>
            <div style="margin-top:8px"><strong>Bio</strong><div id="right-bio" style="color:var(--gray)"></div></div>
            <div style="margin-top:8px"><strong>Skills</strong>
              <div class="skills" id="right-skills" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Quick Actions</strong>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="add-project" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">Tambah Proyek</button>
            <button id="edit-profile-2" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">Edit Profil</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Supabase and app logic -->
  <script type="module">
import supabase from "./supabaseClient.js"
const PROFILE_BUCKET = "profile_pictures"

// DOM helper
const $ = s => document.querySelector(s)

// ---- PAGE ELEMENTS ----
const pageHomeBtn = $('#page-home-btn')
const pageSkillBtn = $('#page-skill-btn')
const pageShowcaseBtn = $('#page-showcase-btn')

const pageHome = $('#page-home')
const pageSkill = $('#page-skill')
const pageShowcase = $('#page-showcase')

const avatarImg = $('#avatar-img')
const profileName = $('#profile-name')
const profileRole = $('#profile-role')
const profileBio = $('#profile-bio')
const greetName = $('#greet-name')
const rightName = $('#right-name')
const rightBio = $('#right-bio')
const rightSkills = $('#right-skills')

const techSkills = $('#tech-skills')
const designSkills = $('#design-skills')
const softSkills = $('#soft-skills')

const activityList = $('#activity-list')
const portfolioGrid = $('#portfolio-grid')
const progressBar = $('#progress-bar')
const profilePercent = $('#profile-percent')
const homeIntro = $('#home-intro')

// ---- PAGE NAV ----
function showPage(x){
  pageHome.style.display = x=='home' ? 'block':'none'
  pageSkill.style.display = x=='skill' ? 'block':'none'
  pageShowcase.style.display = x=='showcase' ? 'block':'none'

  pageHomeBtn.classList.toggle('active', x=='home')
  pageSkillBtn.classList.toggle('active', x=='skill')
  pageShowcaseBtn.classList.toggle('active', x=='showcase')
}
pageHomeBtn.onclick = ()=> showPage('home')
pageSkillBtn.onclick = ()=> showPage('skill')
pageShowcaseBtn.onclick = ()=> showPage('showcase')

// ---- LOGOUT ----
$('#btn-logout').addEventListener('click', async ()=>{
  await supabase.auth.signOut()
  // redirect otomatis ditangani listener
})

// ---- UTILS ----
function makeTag(t){
  const d = document.createElement("div")
  d.className = "tag"
  d.textContent = t
  return d
}
function parseSkillsField(f){
  if (!f) return []
  if (Array.isArray(f)) return f
  return f.split(",").map(s=>s.trim()).filter(Boolean)
}

// ---- PROFILE LOADER ----
async function loadProfile(uid){
  const { data, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", uid)
    .single()

  if (error){ console.error(error); return }

  renderProfile(data)
}

// ---- RENDER PROFILE ----
function renderProfile(p){
  const fullName = p.full_name || "Tanpa Nama"
  profileName.textContent = fullName
  greetName.textContent = fullName.split(" ")[0]

  profileRole.textContent = p.university
    ? `${p.university} • ${p.major || ""} `
    : ""

  const bio = p.bio || "Belum menambahkan bio"
  profileBio.textContent = bio
  rightBio.textContent = bio

  homeIntro.textContent = `Halo ${fullName.split(" ")[0]}, selamat datang di dashboardmu.`

  // PROFILE PICTURE
  let avatarSrc = ""
  if (p.profile_picture){
    if (p.profile_picture.startsWith("http")){
      avatarSrc = p.profile_picture
    } else {
      const { data } = supabase.storage.from(PROFILE_BUCKET).getPublicUrl(p.profile_picture)
      avatarSrc = data.publicUrl
    }
  }
  avatarImg.src = avatarSrc || "assets/default-profile.png"

  // SKILLS
  const hard = parseSkillsField(p.hard_skills)
  const soft = parseSkillsField(p.soft_skills)

  techSkills.innerHTML = ""
  designSkills.innerHTML = ""
  softSkills.innerHTML = ""
  rightSkills.innerHTML = ""

  const designKeywords = ["ui","ux","figma","wireframe","prototype"]
  const tech = []
  const design = []

  hard.forEach(s=>{
    if (designKeywords.some(k=>s.toLowerCase().includes(k)))
      design.push(s)
    else tech.push(s)
  })

  tech.forEach(s=> techSkills.appendChild(makeTag(s)))
  design.forEach(s=> designSkills.appendChild(makeTag(s)))
  soft.forEach(s=> softSkills.appendChild(makeTag(s)))
  ;[...hard,...soft].slice(0,6).forEach(s=> rightSkills.appendChild(makeTag(s)))

  // ACTIVITY
  activityList.innerHTML = ""
  const acts = p.recent_activity || [{ text:"Profil dibuat", when:"Baru saja" }]
  acts.forEach(a=>{
    const li = document.createElement("li")
    li.textContent = `${a.text} — ${a.when}`
    activityList.appendChild(li)
  })

  // PROGRESS
  let done = 0
  if (p.profile_picture) done += 25
  if (p.full_name) done += 25
  if (hard.length || soft.length) done += 25
  if (p.showcase_items?.length) done += 25
  progressBar.style.width = `${done}%`
  profilePercent.textContent = `${done}% Selesai`
}

// ---- SAFE SESSION CHECK ----
async function getSessionSafe(){
  // tunggu sebentar agar Supabase load session di browser
  await new Promise(r => setTimeout(r, 100))
  const { data: { session } } = await supabase.auth.getSession()
  return session
}

// ---- START DASHBOARD ----
document.addEventListener("DOMContentLoaded", async ()=>{
  const session = await getSessionSafe()
  if (!session){
    console.log("No session detected — redirecting to login")
    window.location.href = "/index.html"
    return
  }

  console.log("Session active — loading dashboard:", session.user.email)
  loadProfile(session.user.id)
})

// LISTENER AUTH STATE (untuk logout di tab lain)
supabase.auth.onAuthStateChange((event, session)=>{
  if (!session){
    console.log("Session expired / logged out — redirecting to login")
    window.location.href = "/index.html"
  }
})
</script>
</body>
</html>